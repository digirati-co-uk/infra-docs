# Using your Yubikey

The Yubikey that the company provides employees with is known as a **hardware security token**.
It functions as a portable security processor and is able to handle storage of cryptographic secrets.
In short, this means it can be used in place of a personal device for storage of MFA secrets and crypto keys.

There are a number of different protocols and applications that your Yubikey can be applied to, here's a list of the main supported usecases:

### Multi-factor authentication

Yubikey is the preferred device for multi-factor authentication scenarios.
To support this the Yubikey supports several MFA protocols:

- TOTP/HOTP codes
- OTP verification
- FIDO/U2f

FIDO/U2F and TOTP codes are the most commonly used approaches.
Any modern web browser supports FIDO/U2F, while TOTP codes are generated by a Google Authenticator-like application.
Since the codes are stored on the Yubikey these codes can be obtained easily on different devices provided the Yubikey hardware is available.

### SSH key storage

It's possible to use a Yubikey to hold an SSH key by using GPG-agent as
the SSH-agent and storing the key as a GPG key with authentication
capabilities. This makes your SSH ID more secure, and portable between
machines with some configuration.

### GPG Encryption, decryption, and signing

The Yubikey device can also act as an OpenPGP card. It can store encryption and signing keys that can be used to authenticate or protect sensitive data.

### PAM / Windows Hello

Yubikeys can be used to login to Linux, Windows or Mac operating
systems.

# Setup guides

## Yubikey Best Practice

The Yubikey is a very useful tool, but one big draw back is that by default once it's plugged into your machine it can be used
by software while your machine is unattended. This is prevented by certain protocols such as FIDO/U2F, however, to ensure that
TOTP codes have the same protection the user must enable the touch requirement for the TOTP code when importing into Yubikey Authenticator.

In addition, the same applies to users that are using their key for encryption/decryption.
This option must be configured on the Yubikey itself, and can be set using the Yubikey Personalization Tool GUI or by running the following commands:

1. `ykman openpgp touch enc on`
1. `ykman openpgp touch aut on`
1. `ykman openpgp touch sig on`

## Multi-factor Authentication

Most services that offer support for MFA currently use a TOTP based approach to authentication.
This is not the preferred mechanism, instead FIDO/U2F should be used when available.
A user can tell the difference by checking how their Yubikey is enrolled into MFA:

- If there's a QR code or anything to import into the Yubikey, it's TOTP
- If the Yubikey is enrolled into the service, it's FIDO/U2F

### GitHub

1. Go to your [GitHub Security Settings](https://github.com/settings/security)
2. Turn on `Two-factor Authentication` if it's not already enabled. You will
   need to set up either an SMS or TOTP (Google Authenticator) if it's not.
3. Under `Security keys, choose `Register new device`
4. Type in a name: `yourname-Yubikey-nano4` or something else that will help
   you remember the key
5. Click `Add`
6. Follow the instructions on screen - you'll probably need to tap the Yubikey
   for it to register.

Yubico has more [detailed instructions](https://www.yubico.com/support/knowledge-base/categories/articles/use-Yubikey-github/).

### Google

1. Go to your [Google Sign-in & Security page](https://myaccount.google.com/security)
2. Click `Two-step verification` and you may be prompted for your password.
3. Click `Add Security Key` and follow the on-screen instructions. You may
   need to tap or touch your Yubikey.

Yubico has a [video](https://www.yubico.com/why-yubico/for-individuals/gmail-for-individuals/)

### LastPass

LastPass supports OTP and TOTP as a two factor method and does not
support U2F.

1. Go to your [LastPass account details](https://lastpass.com/)
2. Click `Two-step verification` and you may be prompted for your password.
3. Click `Enable MFA` and follow the on-screen instructions. When prompted, touch the Yubikey to generate a one-time password.

Yubico has a [video](https://www.yubico.com/gb/works-with-Yubikey/catalog/lastpass-premium-and-families/).

### Other

#### Using the Yubico Authenticator

To configure multi-factor authentication with a service that only supports TOTP: Download Yubico Authenticator, then File > Add.

Click Scan a QR code if a QR code is visible on the screen or manually enter the details. The QR code is usually a visual representation of the following address URL-encoded:

```otpauth://totp/<email>?issuer=<issuer>&secret=<secret>```

 - Credential name: the name of the provider (e.g. GitHub)
 - Secret key (base32): the secret key (32 characters)
 - Credential type: usually TOTP, but can be HOTP
 - Number of digits: usually 6, but can be up to 8
 - Algorithm: usually SHA-1, but can be SHA-256
 - Require touch: enable

## Securely exchanging secrets

Besides MFA the main function of the Yubikey is providing easy access to encryption/decryption/signing.
The Yubikey facilitates this by supporting OpenPGP on the device and this extends to making OpenPGP authentication keys available for use in SSH.

Setting up GPG is quite an involved process, and it is recommended to follow the [official guide](https://github.com/drduh/YubiKey-Guide) for GPG on Yubikey.
Unfortunately, there is no GUI friendly way to set this up as of today. Assistance is available to users who would like to setup encryption/decryption on their Yubikey via the #devops-chapter Slack channel.

Once GPG has been configured it is important that you distribute your public key among the company so others can send encrypted data to you when needed. This can be done by uploading the public key from the process above into the #devops-chapter Slack channel.

## SSH authentication

Using a Yubikey for SSH authentication relies on it being already set up for GPG use with an Authentication sub-key as in the guide above.
OpenSSH and PuTTY are supported out of the box by GPG, however, they need a line of configuration to enable the option.

### Windows:

Open the Klepoatra configuration folder and edit the gpg-agent.conf file, update it to include:

```
enable-putty-support
```

### Linux

Similarly to Windows, open ~/.gnupg/gpg-agent.conf and update it to include:

```
enable-ssh-support
```

`gpg-connect-agent /bye` can be run to start a new GPG agent and OpenSSH/PuTTY should begin using this straight away.
